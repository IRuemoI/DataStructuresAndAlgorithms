## 21节：树上的操作优化问题

### 题目一：子树节点值的操作

#### 题目

给定一棵树，每个节点有一个初始值。支持以下两种操作：

1. 查询某子树所有节点的值的累加和。
2. 将某子树所有节点的值加上一个指定值v。

#### 思路

- **重链剖分（Heavy-Light Decomposition, HLD）**：将树分解成若干条重链和轻链。
- **线段树（Segment Tree）**：利用线段树对连续区间进行快速更新和查询。
- 具体步骤如下：
  - 第一遍DFS
    - 计算每个节点的子树大小。
    - 找到每个节点的重儿子。
  - 第二遍DFS
    - 给每个节点分配一个dfs序号。
    - 确定每条重链的头节点。
  - 构建线段树
    - 根据dfs序构建线段树。
  - 执行操作
    - 对于子树求和或更新操作，转化为对连续区间的操作。

### 题目二：树上路径的操作

#### 题目

给定一棵树，每个节点有一个初始值。支持以下两种操作：

1. 查询从节点a到节点b路径上所有节点的值的累加和。
2. 将从节点a到节点b路径上所有节点的值加上一个指定值v。

#### 思路

- **重链剖分（Heavy-Light Decomposition, HLD）**：将树分解成若干条重链和轻链。
- **线段树（Segment Tree）**：利用线段树对连续区间进行快速更新和查询。
- 具体步骤如下：
  - 第一遍DFS
    - 计算每个节点的子树大小。
    - 找到每个节点的重儿子。
  - 第二遍DFS
    - 给每个节点分配一个dfs序号。
    - 确定每条重链的头节点。
  - 构建线段树
    - 根据dfs序构建线段树。
  - 执行操作
    - 对于路径求和或更新操作，通过跳重链的方式，将路径拆分为若干个连续区间，然后在这些区间上进行操作。

### 注意事项

- 在实现过程中，注意节点编号是从1开始还是从0开始。
- 第一遍DFS用于计算子树大小和找到重儿子，第二遍DFS用于分配dfs序号和确定重链头节点。
- 构建线段树时，确保按照正确的dfs序来组织数据。
- 操作时，注意处理边界情况，例如单节点树、路径上的重复节点等。